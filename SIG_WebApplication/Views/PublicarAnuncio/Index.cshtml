
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutBusiness.cshtml";
}

<br />
<br />
<br />
<!-- Shoping Cart -->

<div class="container bg0 p-t-75 p-b-85">
    <div class="row">
        <div class="col-md-12">
            <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-10 m-r-4 m-lr-0-xl p-lr-15-sm">
                <div class="row">
                    <div class="col-md-6">
                        <h5><strong>Publica tu anuncio</strong> </h5>
                        <br />
                        <label>Categoria</label>
                        <div id="DivSubCategoria" class="rs1-select2 rs2-select2 bor8 bg0 m-b-5 m-t-5 col-md-12">
                            @Html.DropDownList("SubCategoria", new SelectList(ViewBag.SubCategorias, "ID", "Nombre"), htmlAttributes: new { @class = "js-select2", @onchange = "callSubCategoria(this.value)" })

                            <div class="dropDownSelect2"></div>
                        </div>
                        <label>Tipo de inmueble </label>
                        <div id="DivTipoSubCategorias" style="display:none;">
                            <div id="DivIdTipoSubCategoria" class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                                <select id="IdTipoSubCategoria" class="js-select2" name="time">
                                </select>
                                <div class="dropDownSelect2"></div>
                            </div>
                        </div>
                        <div class="m-b-30 m-t-5 col-md-12">
                            <br />
                            <hr />
                            <label style="font-size:12px;"><strong> Formato de imágenes permitidas: .png, jpg, jpeg </strong> </label>
                            <br />
                            <button type="button" id="BtnCargarImagen" class="flex-c-m cl0 size-125 bg3 bor2 hov-btn3 p-lr-15 trans-04"><i class="fa fa-plus-circle" aria-hidden="true"></i>&nbsp; Subir imágenes </button>

                        </div>

                        <label>Titulo</label>
                        <div id="DivTitulo" class="bor8 bg0 m-b-5 m-t-5 col-md-12">
                            <input class="stext-111 size-116 p-l-15 " type="text" name="Titulo" id="Titulo" placeholder="Titulo">
                        </div>

                        <label>Descripción </label>
                        <div id="DivDescripcion" class="bor8 bg0 m-b-5 m-t-5 col-md-12">
                            <textarea class="stext-111  size-120 p-lr-19 p-tb-25" id="Descripcion" name="msg"></textarea>
                        </div>

                        <label>Ubicación </label>
                        <div id="DivCatEstados" class="rs1-select2 rs2-select2 bor8 bg0 m-b-5 m-t-5 col-md-12">
                            @Html.DropDownList("CatEstados", new SelectList(ViewBag.CatEstados, "ID", "Estado"), htmlAttributes: new { @class = "js-select2", @onchange = "callEstados(this.value)" })
                            <div class="dropDownSelect2"></div>
                        </div>
                        <div id="DivEstados" style="display:none;">
                            <div id="DivIdmunicipio" class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                                <select id="Idmunicipio" class="js-select2" name="time" onchange="callCodigoPostal(this.value)">
                                </select>
                                <div class="dropDownSelect2"></div>
                            </div>
                        </div>
                        <div id="DivCodigoPostal" style="display:none;">
                            <div id="DivIdCodigoPostal" class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                                <select id="IdCodigoPostal" class="js-select2" name="time" onchange="callColonias(this.value)">
                                </select>
                                <div class="dropDownSelect2"></div>
                            </div>
                        </div>
                        <div id="DivColonias" style="display:none;">
                            <div id="DivIdColonias" class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                                <select id="IdColonias" class="js-select2" name="time">
                                </select>
                                <div class="dropDownSelect2"></div>
                            </div>
                        </div>

                        <label>Baños </label>
                        <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                            <select class="js-select2" name="time" id="WC">
                                <option>0</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                                <option>mas de 5</option>
                            </select>
                            <div class="dropDownSelect2"></div>
                        </div>
                        <label>Estacionamientos </label>
                        <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                            <select class="js-select2" name="time" id="Estacionamientos">
                                <option>0</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                                <option>mas de 5</option>
                            </select>
                            <div class="dropDownSelect2"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Unidad de medida  </label>
                                <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                                    @Html.DropDownList("UnidadMedida", new SelectList(ViewBag.UnidadMedidas, "Id", "Nombre"), htmlAttributes: new { @class = "js-select2" })

                                    <div class="dropDownSelect2"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label>Superficie construida </label>
                                <div id="DivSuperficie" class="bor8 bg0 m-b-5 m-t-5 col-md-12">
                                    <input class="stext-111 size-116 p-l-15 " id="Superficie" type="text" name="Superficie" placeholder="Superficie" onkeypress="return soloNum(event)">
                                </div>
                            </div>
                        </div>

                        <label>Superficie de terreno </label>
                        <div id="DivSuperficieT" class="bor8 bg0 m-b-5 m-t-5 col-md-12">
                            <input class="stext-111 size-116 p-l-15 " id="SuperficieT" type="text" name="SuperficieT" placeholder="Superficie de terreno" onkeypress="return soloNum(event)">
                        </div>
                        <label>Precio </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div id="DivPrecio" class="bor8 bg0 m-b-5 m-t-5 col-md-12">
                                    <input class="stext-111 size-116 p-l-15 " id="Precio" type="text" name="Precio" placeholder="Precio" onkeypress="return soloNum(event)">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="rs1-select2 rs2-select2 bor8 bg0 m-b-9 m-t-9 col-md-12">
                                    @Html.DropDownList("CatMonedas", new SelectList(ViewBag.CatMonedas, "ID", "Nombre"), htmlAttributes: new { @class = "js-select2" })

                                    <div class="dropDownSelect2"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-6">
                        <h5><strong>Imagines inmueble</strong> </h5>
                        <br />
                        <p>Al realizar la carga de las imágenes, se mostrará una vista previa de la misma.</p>
                        <hr />
                        <div class="col-md-12">
                            <div id="Galeria">
                            </div>
                        </div>
                        <hr />
                        <strong>Tú publicación es evaluada, en un periodo de 24 horas tu publicación estará disponible </strong>
                    </div>
                </div>
                <div class="m-b-30 m-t-5 col-md-12">
                    <br />
                    <button type="button" id="BtnPublicar" class="flex-c-m cl0 size-125 bg3 bor2 hov-btn3 p-lr-15 trans-04"> Publicar </button>
                </div>
                <input id="fileInput" type="file" multiple style="visibility:hidden">



            </div>
        </div>
    </div>
</div>
<div class="bg6 flex-c-m flex-w size-302 ">
    <span class="stext-107 cl6 p-lr-25">

    </span>

    <span class="stext-107 cl6 p-lr-25">

    </span>
</div>
@*<script src="~/assets/js/main.js"></script>*@
<script>
    $("#BtnPublicar").click(function () {

        if (ValidarPublicacion()) {
            $("#BtnPublicar").prop('disabled', true);

            var obj = {};
            obj['Titulo'] = $('#Titulo').val();
            obj['Descripcion'] = $('#Descripcion').val();
            obj['IdSubCategoria'] = $('#SubCategoria').val();
            obj['IdTipoSub'] = $('#IdTipoSubCategoria').val();
            obj['IdEstado'] = $('#CatEstados').val();
            obj['IdPoblacion'] = $('#Idmunicipio').val();
            obj['IdCP'] = $('#IdCodigoPostal').val();
            obj['IdColonia'] = $('#IdColonias').val();
            obj['WC'] = $('#WC').val();
            obj['Estacionamientos'] = $('#Estacionamientos').val();
            obj['Superficie'] = $('#Superficie').val();
            obj['SuperficieT'] = $('#SuperficieT').val();
            obj['Precio'] = $('#Precio').val();
            obj['IdMoneda'] = $('#CatMonedas').val();
            obj['IdUnidadMedida'] = $('#UnidadMedida').val();


            var jsonObject = {
                "inmueble": obj
            };

            console.log(jsonObject);

            $.ajax({
                url: "@Url.Action("RegistraNuevo_Inmueble", "PublicarAnuncio")",
                type: "POST",
                data: JSON.stringify(jsonObject),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                error: function (response) {
                    alert("MANDAR MENSAJE SE ERROR");
                },
                success: function (response) {
                    if (response.Respuesta) {
                        swal({
                            title: "Publicacion. !",
                            text: response.Contenido,
                            icon: "success",
                            button: "Aceptar",
                        })
                            .then((value) => {
                                window.location.href = '@Url.Action("Index","Micuenta")';
                            });
                    }
                    else {
                        $.notify({
	                        icon: 'fa fa-paw',
	                        message: response.RespuestaText,
                        },{
                            type: 'danger',
                            allow_dismiss: false,
                            animate: {
		                        enter: 'animated rollIn',
		                        exit: 'animated rollOut'
	                        }
                        });

                        $("#BtnPublicar").prop('disabled', false);
                    }
                }

            });
        } else {
            $.notify({
	                icon: 'fa fa-paw',
	                message: "Formulario incompleto ."
                },{
                        type: 'danger',
                    allow_dismiss: false,
                    animate: {
		                enter: 'animated rollIn',
		                exit: 'animated rollOut'
	                }
                });
        }




    });

    function ValidarPublicacion() {
        var respuesta = false;

        $('#DivSubCategoria').css("border-bottom", "1px solid #e6e6e6");
        $('#DivIdTipoSubCategoria').css("border-bottom", "1px solid #e6e6e6");
        $('#DivTitulo').css("border-bottom", "1px solid #e6e6e6");
        $('#DivDescripcion').css("border-bottom", "1px solid #e6e6e6");
        $('#DivCatEstados').css("border-bottom", "1px solid #e6e6e6");
        $('#DivIdmunicipio').css("border-bottom", "1px solid #e6e6e6");
        $('#DivIdCodigoPostal').css("border-bottom", "1px solid #e6e6e6");
        $('#DivIdColonias').css("border-bottom", "1px solid #e6e6e6");
        $('#DivSuperficie').css("border-bottom", "1px solid #e6e6e6");
        $('#DivPrecio').css("border-bottom", "1px solid #e6e6e6");
        $('#DivSuperficieT').css("border-bottom", "1px solid #e6e6e6");

        if ($('#SubCategoria').val() > 0) {
        }else {
            $('#DivSubCategoria').css("border-bottom", "1px solid red");
            $('#DivSubCategoria').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#IdTipoSubCategoria').val() > 0) {
        }else {
            $('#DivIdTipoSubCategoria').css("border-bottom", "1px solid red");
            $('#DivIdTipoSubCategoria').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#Titulo').val().length > 0) {
        }else {
            $('#DivTitulo').css("border-bottom", "1px solid red");
            $('#DivTitulo').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#Descripcion').val().length > 0) {
        }else {
            $('#DivDescripcion').css("border-bottom", "1px solid red");
            $('#DivDescripcion').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#CatEstados').val() > 0) {
        }else {
            $('#DivCatEstados').css("border-bottom", "1px solid red");
            $('#DivCatEstados').css("box-shadow", "0 1px 0 0 red !important;");
        }
        if ($('#Idmunicipio').val() > 0) {
        }else {
            $('#DivIdmunicipio').css("border-bottom", "1px solid red");
            $('#DivIdmunicipio').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#IdCodigoPostal').val() > 0) {
        }else {
            $('#DivIdCodigoPostal').css("border-bottom", "1px solid red");
            $('#DivIdCodigoPostal').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#IdColonias').val() > 0) {
        }else {
            $('#DivIdColonias').css("border-bottom", "1px solid red");
            $('#DivIdColonias').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#Superficie').val().length > 0) {
        }else {
            $('#DivSuperficie').css("border-bottom", "1px solid red");
            $('#DivSuperficie').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#Precio').val().length > 0) {
        }else {
            $('#DivPrecio').css("border-bottom", "1px solid red");
            $('#DivPrecio').css("box-shadow", "0 1px 0 0 red !important;");
        }

        if ($('#SuperficieT').val().length > 0) {
        }else {
            $('#DivSuperficieT').css("border-bottom", "1px solid red");
            $('#DivSuperficieT').css("box-shadow", "0 1px 0 0 red !important;");
        }



    /*******************************************************/

        if ($('#SubCategoria').val() > 0) {
            if ($('#IdTipoSubCategoria').val() > 0) {
                if ($('#Titulo').val().length > 0) {
                    if ($('#Descripcion').val().length > 0) {
                        if ($('#CatEstados').val() > 0) {
                            if ($('#Idmunicipio').val() > 0) {
                                if ($('#IdCodigoPostal').val() > 0) {
                                    if ($('#IdColonias').val() > 0) {
                                        if ($('#Superficie').val().length > 0) {
                                            if ($('#Precio').val().length > 0) {
                                                if ($('#SuperficieT').val().length > 0) {
                                                    respuesta = true;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }






        return respuesta;
    }



    function callSubCategoria(valor) {
        $("#DivTipoSubCategorias").css("display", "none");
        $("#IdTipoSubCategoria").empty();
        var obj = {};
        obj['IdSubCategoria'] = valor;
        var jsonObject = {
            "TipoSubCategoria": obj
        };

        $.ajax({
            url: "@Url.Action("CargaTipoSubCategoria", "PublicarAnuncio")",
            type: "POST",
            data: JSON.stringify(jsonObject),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (resultado) {
                alert("MANDAR MENSAJE SE ERROR");
            },
            success: function (resultado) {
                $("#DivTipoSubCategorias").css("display", "block");

                 //var datos = $.parseJSON(msg.d);

                $(resultado).each(function () {
                    var option = $(document.createElement('option'));

                    option.text(this.Nombre);
                    option.val(this.Id);

                    $("#IdTipoSubCategoria").append(option);
                });
            }

        });

    }


    function callColonias(valor) {
        $("#DivColonias").css("display", "none");
        $("#IdColonias").empty();
        var obj = {};
        obj['IdCP'] = valor;
        var jsonObject = {
            "cat_Colonias": obj
        };
        $.ajax({
            url: "@Url.Action("CargaColonias", "PublicarAnuncio")",
            type: "POST",
            data: JSON.stringify(jsonObject),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (resultado) {
                alert("MANDAR MENSAJE SE ERROR");
            },
            success: function (resultado) {
                $("#DivColonias").css("display", "block");

                 //var datos = $.parseJSON(msg.d);

                $(resultado).each(function () {
                    var option = $(document.createElement('option'));

                    option.text(this.Colonia);
                    option.val(this.Id);

                    $("#IdColonias").append(option);
                });
            }

        });
    }


    function callCodigoPostal(valor) {
        $("#DivCodigoPostal").css("display", "none");
         $("#IdCodigoPostal").empty();
        var obj = {};
        obj['IdPoblacion'] = valor;
        var jsonObject = {
            "cat_cp": obj
        };

        $.ajax({
            url: "@Url.Action("CargaPostales", "PublicarAnuncio")",
            type: "POST",
            data: JSON.stringify(jsonObject),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (resultado) {
                alert("MANDAR MENSAJE SE ERROR");
            },
            success: function (resultado) {
                $("#DivCodigoPostal").css("display", "block");

                 //var datos = $.parseJSON(msg.d);

                $(resultado).each(function () {
                    var option = $(document.createElement('option'));

                    option.text(this.CP);
                    option.val(this.Id);

                    $("#IdCodigoPostal").append(option);

                });
                 $("#IdCodigoPostal" ).change();
            }
        });
    }


    function callEstados(valor) {
        $("#DivEstados").css("display", "none");
        $("#Idmunicipio").empty();

        var obj = {};
        obj['IdEstado'] = valor;
        var jsonObject = {
            "cat_Poblaciones": obj
        };

        $.ajax({
            url: "@Url.Action("CargaPoblaciones", "PublicarAnuncio")",
            type: "POST",
            data: JSON.stringify(jsonObject),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (resultado) {
                alert("MANDAR MENSAJE SE ERROR");
            },
            success: function (resultado) {
                $("#DivEstados").css("display", "block");

                 //var datos = $.parseJSON(msg.d);

                $(resultado).each(function () {
                    var option = $(document.createElement('option'));

                    option.text(this.Poblacion);
                    option.val(this.Id);

                    $("#Idmunicipio").append(option);
                });



            }
        });
    }




    $( "#BtnCargarImagen" ).click(function() {
        $( "#fileInput" ).click();
    });
    //$(document).ready(function () {
    $('#fileInput').change(function () {
        var formdata = new FormData();
        //FormData object
        var fileInput = document.getElementById('fileInput');
        //Iterating through each files selected in fileInput
        var Carga = false;
        var Formato = "";


        if (fileInput.files.length > 0) {

            for (i = 0; i < fileInput.files.length; i++) {
                var ext = fileInput.files[i].name.split('.').pop();

                // Convertimos en minúscula porque 
                // la extensión del archivo puede estar en mayúscula
                ext = ext.toLowerCase();

                if (ext == 'png' || ext == 'jpg' || ext == 'jpeg') {
                    Carga = true;
                } else {
                    Carga = false;
                    Formato = ext;
                    break;
                }
            }

            if (Carga) {

                for (i = 0; i < fileInput.files.length; i++) {
                    formdata.append(fileInput.files[i].name, fileInput.files[i]);
                }

                if (fileInput.files.length > 0) {
                    swal({
                        title: "Cargando...",
                        text: "Por favor espera",
                        icon: "../images/icons/ajax-loader.gif",
                        button: false,
                        closeOnClickOutside: false,
                        closeOnEsc: false
                    });

                }

                //Creating an XMLHttpRequest and sending
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/PublicarAnuncio/CargaImagen');
                xhr.responseType = "json";
                xhr.send(formdata);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        PintaGaleria(xhr.response);
                        swal.close();
                    }
                }


            } else {
                swal({
                    title: "Intentas cargar un formato no permitido: " + Formato,
                    text: "Formato de imágenes permitidos: .jpg, .jpeg ó.png ",
                    icon: "warning",
                    button: "Aceptar",
                });
            }
        }
        return false;
    });

    function PintaGaleria(Contenido) {
        $('#Galeria').html('');
        var Galeria = '';
        if (Contenido.length > 0) {
            Galeria += '<div class="wrap-slick3 flex-sb flex-w">' +
                            '<div class="wrap-slick3-dots"></div>' +
                            '<div class="wrap-slick3-arrows flex-sb-m flex-w"></div>' +
                            '<div class="slick3 gallery-lb">';

            for (var b = 0; b < Contenido.length; b++) {
                    Galeria += '<div class="item-slick3" data-thumb="http://' + Contenido[b].Descripcion + '">' +
                        '<div class="wrap-pic-w pos-relative">' +
                        '<img src="http://' + Contenido[b].Descripcion + '" alt="IMG-PRODUCT">' +
                        '<a class="flex-c-m size-108 how-pos1 bor0 fs-16 cl10 bg0 hov-btn3 trans-04" onclick="EliminarElmento(' + Contenido[b].IdArchivo + ')">' +
                        '<i class="fa fa-trash" aria-hidden="true"></i>' +
                        '</a>' +
                        '<div class="m-b-30 m-t-5 col-md-12">' +
                            '<br />' +
                            '<button type="button" id="BtnCargarImagen" class="flex-c-m cl0 size-125 bg3 bor2 hov-btn3 p-lr-15 trans-04" onclick="OrdenarElmento(' + Contenido[b].IdArchivo + ')"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i>&nbsp; Colocar imagen como principal </button>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
            }

            Galeria +=      '</div>' +
                        '</div>';
        }
        $('#Galeria').html(Galeria);

        $('.wrap-slick3').each(function () {

            $(this).find('.slick3').slick({
                slidesToShow: 1,
                slidesToScroll: 1,
                fade: true,
                infinite: true,
                autoplay: false,
                autoplaySpeed: 6000,

                arrows: true,
                appendArrows: $(this).find('.wrap-slick3-arrows'),
                prevArrow:'<button class="arrow-slick3 prev-slick3"><i class="fa fa-angle-left" aria-hidden="true"></i></button>',
                nextArrow:'<button class="arrow-slick3 next-slick3"><i class="fa fa-angle-right" aria-hidden="true"></i></button>',



                dots: true,
                centerMode: true,
                focusOnSelect: true,
                appendDots: $(this).find('.wrap-slick3-dots'),
                dotsClass:'slick3-dots',
                customPaging: function(slick, index) {
                    var portrait = $(slick.$slides[index]).data('thumb');
                    return '<img src=" ' + portrait + ' "/><div class="slick3-dot-overlay"></div>';
                },
            });
        });



    }

    function EliminarElmento(contenido) {
        var obj = {};
        obj['IdArchivo'] = contenido;
        var jsonObject = {
            "InmueblesImg": obj
        };

        $.ajax({
            url: "@Url.Action("EliminarImagen", "PublicarAnuncio")",
            type: "POST",
            data: JSON.stringify(jsonObject),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert("MANDAR MENSAJE SE ERROR");
                        },
            success: function (response) {
                PintaGaleria(response);

                $.notify({
	                icon: 'fa fa-paw',
	                message: "Imagen eliminada."
                },{
                    type: 'info',
                    allow_dismiss: false,
                    animate: {
		                enter: 'animated rollIn',
		                exit: 'animated rollOut'
	                }
                });
            }
        });
    }

    function OrdenarElmento(contenido) {
        var obj = {};
        obj['IdArchivo'] = contenido;
        var jsonObject = {
            "InmueblesImg": obj
        };

        $.ajax({
            url: "@Url.Action("OrdenarImagenes", "PublicarAnuncio")",
            type: "POST",
            data: JSON.stringify(jsonObject),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            error: function (response) {
                alert("MANDAR MENSAJE SE ERROR");
                        },
            success: function (response) {
                PintaGaleria(response);


                $.notify({
	                icon: 'fa fa-paw',
	                message: "Has colocado esta imagen como imagen principal del inmueble."
                },{
                        type: 'success',
                    allow_dismiss: false,
                    animate: {
		                enter: 'animated rollIn',
		                exit: 'animated rollOut'
	                }
                });
            }
        });
    }




    //});
</script>